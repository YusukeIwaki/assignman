### **データベースの主要なテーブル（エンティティ）**

サービスの要件を実現するために、以下の概念を表すテーブルを設計します。

#### **1\. 組織 (Organizations)**

* **目的**: 顧客となる企業や団体ごとデータを分離し、管理するための最上位の入れ物です 1。これにより、複数の企業が同じシステムを安全に利用できる状態（マルチテナント）を実現します。

* **主な構造**:  
  * **組織名**: 登録された企業や部署を識別するための名前。

#### **2\. ユーザー (Users)**

* **目的**: システム内でのユーザー識別のためのコアエンティティです。認証情報や公開プロフィール情報は分離されています。

* **主な構造**:  
  * **ID**: プライマリキー  
  * **所属組織**: どの組織に属するユーザーかを示す情報  
  * **作成日時・更新日時**: レコードのタイムスタンプ

#### **2-1\. ユーザー認証情報 (UserCredentials)**

* **目的**: ユーザーのログイン認証に必要な機密情報を管理します。認可（権限）情報は含まず、純粋に認証のためのデータのみを扱います。

* **主な構造**:  
  * **ユーザー参照**: どのユーザーの認証情報かを示すID  
  * **メールアドレス**: ログインに使用する識別子（一意制約）  
  * **パスワードダイジェスト**: ハッシュ化されたパスワード  
  * **作成日時・更新日時**: レコードのタイムスタンプ

* **設計思想**: 認証（Authentication）と認可（Authorization）を分離。権限情報は別モデルで管理することで、複雑な権限システムを柔軟に実装可能にします。

#### **2-2\. ユーザープロフィール (UserProfiles)**

* **目的**: ユーザーの公開可能なプロフィール情報を管理します。認証情報とは分離され、表示やキャッシュに最適化できます。

* **主な構造**:  
  * **ユーザー参照**: どのユーザーのプロフィールかを示すID  
  * **表示名**: システム内で表示される名前  
  * **自己紹介文**: オプションの説明文  
  * **アバターURL**: プロフィール画像のURL（オプション）  
  * **作成日時・更新日時**: レコードのタイムスタンプ

#### **2-3\. 管理者 (Admins)**

* **目的**: プロジェクトの計画策定やメンバーのアサインを実行する権限を持つエンティティです。組織に属し、オプションでユーザーと関連付けることができます。

* **主な構造**:  
  * **ID**: プライマリキー  
  * **所属組織**: どの組織に属する管理者かを示す情報  
  * **ユーザー参照**: 関連するユーザー（オプション）  
  * **作成日時・更新日時**: レコードのタイムスタンプ

#### **3\. メンバー (Members)**

* **目的**: プロジェクトにアサインされる「人的リソース」のプロフィール情報を管理します 4。これはシステムにログインする「ユーザー」とは別の概念です 5。これにより、ログイン権限を持たない外部パートナーなども管理対象に含められます 6。

* **主な構造**:  
  * **所属組織**: どの組織に属するメンバーかを示す情報。  
  * **名前**: メンバーを識別するための氏名。  
  * **標準労働時間**: そのメンバーが週単位で標準的に稼働する時間数（例: 40時間/週）。デフォルトは40時間。

#### **4-1\. 通常プロジェクト (StandardProjects)**

* **目的**: 開始日と終了日が明確に定義された、期間限定の仕事の単位を管理します。アサインの対象となる業務コンテナです。

* **主な構造**:  
  * **所属組織**: どの組織のプロジェクトかを示す情報。  
  * **プロジェクト名**: プロジェクトを識別するための名前。  
  * **開始日・終了日**: プロジェクトの期間（必須）。  
  * **ステータス**: 「tentative（未確定）」「confirmed（確定）」「archived（アーカイブ）」といった、プロジェクトの進行状況。  
  * **クライアント名**: プロジェクトのクライアント（オプション）。  
  * **予算時間**: プロジェクトの予算時間数（オプション）。  
  * **備考**: 追加情報（オプション）。

#### **4-2\. 定常プロジェクト (OngoingProjects)**

* **目的**: 明確な終了日を持たない、継続的な業務を管理します。定常業務や保守業務などが該当します。

* **主な構造**:  
  * **所属組織**: どの組織のプロジェクトかを示す情報。  
  * **プロジェクト名**: プロジェクトを識別するための名前。  
  * **ステータス**: 「active（アクティブ）」「inactive（非アクティブ）」。  
  * **クライアント名**: プロジェクトのクライアント（オプション）。  
  * **予算**: プロジェクトの予算金額（オプション）。  
  * **備考**: 追加情報（オプション）。

#### **5-1\. ラフプロジェクトアサイン (RoughProjectAssignments)**

* **目的**: 管理者が通常プロジェクトの全体計画を策定するために使用する、仮のアサイン情報です。メンバーには公開されません。

* **主な構造**:  
  * **対象の通常プロジェクト**: どの通常プロジェクトへの割り当てかを示す情報。
  * **担当メンバー**: どのメンバーを割り当てるかを示す情報。
  * **期間**: アサインの開始日と終了日（必須）。  
  * **予定時間**: その期間での総予定作業時間数。

#### **5-2\. 詳細プロジェクトアサイン (DetailedProjectAssignments)**

* **目的**: ラフプロジェクトアサインを基に管理者が確定させ、メンバーに通知するための正式なアサイン情報です。

* **主な構造**:  
  * **対象の通常プロジェクト**: どの通常プロジェクトへの割り当てかを示す情報。
  * **担当メンバー**: どのメンバーを割り当てるかを示す情報。
  * **期間**: アサインの開始日と終了日（必須）。  
  * **予定時間**: その期間での総予定作業時間数。

#### **5-3\. 定常アサイン (OngoingAssignments)**

* **目的**: 定常プロジェクトに対してメンバーを割り当てるためのアサイン情報です。これは計画段階を経ず、確定情報として扱われます。

* **主な構造**:  
  * **対象の定常プロジェクト**: どの定常プロジェクトへの割り当てかを示す情報。
  * **担当メンバー**: どのメンバーを割り当てるかを示す情報。
  * **開始日**: アサインの開始日（必須）。
  * **終了日**: アサインの終了日（オプション、未設定の場合は無期限）。  
  * **週次予定時間**: 週あたりの予定作業時間数。

#### **6\. スキル (Skills)**

* **目的**: メンバーの技術的専門知識を構造化するためのマスターデータです。特定の専門技能（例: Python、React）を表し、高度なリソース検索を可能にします。

* **主な構造**:  
  * **所属組織**: どの組織で定義されたスキルかを示す情報。  
  * **名称**: 「Python」や「React」といったスキルの名前。

**注記**: 現在の実装では役割（Role）は独立したエンティティとして実装されておらず、将来的な拡張として予定されています。

#### **7\. メンバースキル (MemberSkills)**

* **目的**: 一人の「メンバー」が複数の「スキル」を持つという関係（多対多）を実現するための、両者をつなぐ中間的なテーブルです。  
* **主な構造**:  
  * **対象メンバー**: どのメンバーかを示す情報。  
  * **対象スキル**: どのスキルかを示す情報。

---

### **エンティティ関連（リレーションシップ）**

上記の各テーブル（概念）は、以下のように相互に関連します。

* **通常プロジェクト**は、多数の**ラフプロジェクトアサイン**と**詳細プロジェクトアサイン**を持つことができます。

* **定常プロジェクト**は、多数の**定常アサイン**を持つことができます。

* **メンバー**は、多数の**ラフプロジェクトアサイン**、**詳細プロジェクトアサイン**、**定常アサイン**を持つことができます。

* 各**アサイン**は、必ず一つの**プロジェクト**と一人の**メンバー**に紐付きます。

* 一人の**メンバー**は、多数の**スキル**を持つことができます（MemberSkillsを通じた多対多の関係）。

* **管理者**は、一つの**組織**に属し、オプションで一人の**ユーザー**と関連付けられます。

* **組織**は、その組織に属する全ての**ユーザー**、**管理者**、**メンバー**、**通常プロジェクト**、**定常プロジェクト**、**スキル**を保有します。

---

### **クエリ設計に関する考慮事項**

このデータベース構造は、以下の重要な業務ロジックを効率的に処理するために不可欠です。

* **メンバーの稼働時間計算**: 特定の期間において、各メンバーに紐づく全ての**アサイン**情報を集計し、予定作業時間を合算する必要があります。  
* **オーバーアロケーションの検出**: 新しい**アサイン**が追加・変更された際、メンバーの日次予定作業時間の合計が、そのメンバーの持つ**標準労働時間**を超過する日がないかをチェックする必要があります。

* **リソースの空き状況検索**: 「特定の**スキル**を持ち、かつ指定期間内の**予定作業時間**が一定以下の**メンバー**」といった高度な検索要件に応える必要があります。これは、複数のテーブルをまたいだ複雑なデータ検索が求められることを意味します。

### ドメインモデルの整理

実装されたドメインモデルを定義します。

* **管理者 (Admin)**
    * プロジェクトの計画策定やメンバーのアサインを行うアクターです。組織に属し、オプションでユーザーと関連付けられます。

* **メンバー (Member)**
    * プロジェクトにアサインされるリソースであり、自身の確定したスケジュールを閲覧するアクターです。
    * **主な属性**: 名前、標準労働時間（週単位、デフォルト40時間）

* **通常プロジェクト (StandardProject)**
    * 明確な期間と目的を持つ、一般的なプロジェクトです。
    * **主な属性**: プロジェクト名、開始日、終了日、ステータス、クライアント名、予算時間、備考

* **定常プロジェクト (OngoingProject)**
    * 決まった終了日がなく、継続的に発生する業務を表します。
    * **主な属性**: プロジェクト名、ステータス、クライアント名、予算、備考

* **ラフプロジェクトアサイン (RoughProjectAssignment)**
    * **管理者**が**通常プロジェクト**の全体計画を策定するために使用する、仮のアサイン情報です。**メンバー**には公開されません。
    * **主な属性**: 対象の通常プロジェクト、対象メンバー、開始日、終了日、予定時間

* **詳細プロジェクトアサイン (DetailedProjectAssignment)**
    * **ラフプロジェクトアサイン**を基に**管理者**が確定させ、**メンバー**に通知するための正式なアサイン情報です。
    * **主な属性**: 対象の通常プロジェクト、対象メンバー、開始日、終了日、予定時間

* **定常アサイン (OngoingAssignment)**
    * **定常プロジェクト**に対して**メンバー**を割り当てるためのアサイン情報です。これは計画段階を経ず、確定情報として扱われます。
    * **主な属性**: 対象の定常プロジェクト、対象メンバー、開始日、終了日（任意）、週次予定時間

---

### ユースケースの厳密な表現

分割したドメインモデルを用いて、ユースケースをより厳密に表現します。

* **ユースケース1: プロジェクト全体計画の策定**
    * **アクター**: **管理者**
    * **トリガー**: **管理者**が**通常プロジェクト**の初期計画を立てる時。
    * **概要**: **管理者**は、対象の**通常プロジェクト**に対して、複数の**メンバー**の稼働を**ラフプロジェクトアサイン**としてシステムに登録する。この時点では、この計画は**管理者**のみ閲覧可能であり、**メンバー**は認知しない。

* **ユースケース2: メンバーへのアサインの確定と通知**
    * **アクター**: **管理者**
    * **トリガー**: **管理者**が**ラフプロジェクトアサイン**の内容を承認し、**メンバー**に正式な業務として割り当てる時。
    * **概要**: **管理者**は、一つまたは複数の**ラフプロジェクトアサイン**を選択し、それを確定させる。この操作により、システムは対応する**詳細プロジェクトアサイン**を作成または更新する。この**詳細プロジェクトアサイン**が作成された時点で、アサイン対象の**メンバー**は自身のスケジュールとして閲覧可能になる。

* **ユースケース3: 定常業務の割り当て**
    * **アクター**: **管理者**
    * **トリガー**: **管理者**が**メンバー**を継続的な業務に割り当てる時。
    * **概要**: **管理者**は、対象の**定常プロジェクト**と**メンバー**を選択し、**定常アサイン**を作成する。このアサインは即時に確定情報として扱われ、対象**メンバー**は自身のスケジュールとして閲覧可能になる。

* **ユースケース4: 自身の確定スケジュールの確認**
    * **アクター**: **メンバー**
    * **トリガー**: **メンバー**が自身の稼働予定を確認する時。
    * **概要**: システムは、ログインしている**メンバー**に紐づく全ての**詳細プロジェクトアサイン**および**定常アサイン**を検索する。**メンバー**はこれらの確定したアサイン情報のみを、週単位または月単位で集計されたカレンダー形式で確認できる。**ラフプロジェクトアサイン**は表示されない。